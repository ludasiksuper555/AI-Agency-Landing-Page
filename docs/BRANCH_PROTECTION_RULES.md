# Налаштування захисту гілок (Branch Protection) згідно ISO 27001

Цей документ містить інструкції щодо налаштування захисту гілок у Git-репозиторії для забезпечення неможливості прямих змін у проекті та дотримання вимог ISO 27001 щодо контролю доступу.

## Загальні принципи

- Всі зміни в основних гілках повинні проходити через процес Pull Request
- Кожен Pull Request повинен отримати схвалення від призначених Code Owners
- Прямі коміти в захищені гілки заборонені
- Всі дії з репозиторієм повинні логуватися для аудиту

## Налаштування в GitHub

### 1. Зробіть репозиторій приватним

1. Перейдіть до налаштувань репозиторію: **Settings > General**
2. Прокрутіть до секції **Danger Zone**
3. Натисніть **Change visibility**
4. Виберіть **Make private**
5. Підтвердіть зміну, ввівши назву репозиторію

### 2. Налаштуйте захист гілок

1. Перейдіть до налаштувань репозиторію: **Settings > Branches**
2. У секції **Branch protection rules** натисніть **Add rule**
3. У полі **Branch name pattern** введіть `main` (або назву вашої основної гілки)
4. Налаштуйте наступні параметри:
   - ✅ **Require a pull request before merging**
     - ✅ **Require approvals** (встановіть мінімум 1 або більше)
     - ✅ **Dismiss stale pull request approvals when new commits are pushed**
     - ✅ **Require review from Code Owners**
   - ✅ **Require status checks to pass before merging**
     - Додайте необхідні перевірки (наприклад, CI тести)
   - ✅ **Require conversation resolution before merging**
   - ✅ **Require signed commits**
   - ✅ **Require linear history**
   - ✅ **Include administrators** (щоб правила застосовувались до всіх)
   - ✅ **Restrict who can push to matching branches**
     - Додайте тільки відповідальних за злиття змін
5. Натисніть **Create** або **Save changes**

### 3. Налаштуйте файл CODEOWNERS

1. Створіть файл `.github/CODEOWNERS` в корені репозиторію
2. Додайте правила для визначення власників коду, наприклад:

```
# Власники всього коду за замовчуванням
* @username1 @username2

# Власники конкретних директорій
/src/frontend/ @frontend-team
/src/backend/ @backend-team

# Власники конкретних файлів
*.js @js-experts
*.ts @ts-experts
```

3. Збережіть файл та закомітьте його в репозиторій

## Налаштування в GitLab

### 1. Зробіть проект приватним

1. Перейдіть до **Settings > General > Visibility, project features, permissions**
2. У секції **Project visibility** виберіть **Private**
3. Натисніть **Save changes**

### 2. Налаштуйте захист гілок

1. Перейдіть до **Settings > Repository**
2. Розгорніть секцію **Protected Branches**
3. У полі **Branch** виберіть `main` (або назву вашої основної гілки)
4. Налаштуйте наступні параметри:
   - **Allowed to merge**: Виберіть тільки ролі Maintainer або вище
   - **Allowed to push**: Виберіть "No one" для повної заборони прямих комітів
   - ✅ **Require approval from code owners**
   - ✅ **Code owner approval is required for all merge requests**
5. Натисніть **Protect**

### 3. Налаштуйте файл CODEOWNERS

1. Створіть файл `.gitlab/CODEOWNERS` в корені репозиторію
2. Додайте правила для визначення власників коду, наприклад:

```
# Власники всього коду за замовчуванням
* @username1 @username2

# Власники конкретних директорій
/src/frontend/ @frontend-team
/src/backend/ @backend-team

# Власники конкретних файлів
*.js @js-experts
*.ts @ts-experts
```

3. Збережіть файл та закомітьте його в репозиторій

## Налаштування ролей користувачів

### GitHub

1. Перейдіть до **Settings > Manage access**
2. Натисніть **Invite a collaborator**
3. Введіть ім'я користувача або email
4. Виберіть роль:
   - **Read**: Може тільки переглядати код та створювати issues
   - **Triage**: Може керувати issues та pull requests, але не може вносити зміни
   - **Write**: Може створювати гілки та pull requests, але не може зливати їх в захищені гілки
   - **Maintain**: Може керувати репозиторієм, але не може змінювати налаштування безпеки
   - **Admin**: Повний доступ
5. Для забезпечення неможливості змін, надавайте користувачам ролі не вище **Triage**

### GitLab

1. Перейдіть до **Settings > Members**
2. Натисніть **Invite members**
3. Введіть ім'я користувача або email
4. Виберіть роль:
   - **Guest**: Може створювати issues та коментувати
   - **Reporter**: Може переглядати код, але не може вносити зміни
   - **Developer**: Може створювати гілки та merge requests, але не може зливати їх в захищені гілки
   - **Maintainer**: Може керувати проектом та зливати merge requests
   - **Owner**: Повний доступ
5. Для забезпечення неможливості змін, надавайте користувачам ролі не вище **Reporter**

## Налаштування журналів аудиту

### GitHub

1. Для організацій з планом Enterprise:

   - Перейдіть до **Settings > Audit log**
   - Налаштуйте експорт журналів аудиту для довгострокового зберігання

2. Для всіх репозиторіїв:
   - Увімкніть **Security alerts** в налаштуваннях репозиторію
   - Налаштуйте повідомлення про події безпеки

### GitLab

1. Для проектів з планом Premium або вище:

   - Перейдіть до **Settings > Monitor > Audit Events**
   - Налаштуйте експорт журналів аудиту для довгострокового зберігання

2. Для всіх проектів:
   - Увімкніть **Pipeline status emails** в налаштуваннях CI/CD
   - Налаштуйте повідомлення про події безпеки

## Додаткові заходи безпеки

### Підписані коміти

1. Налаштуйте GPG-ключі для всіх розробників
2. Вимагайте підписані коміти для всіх змін
3. Перевіряйте підписи комітів під час code review

### Двофакторна аутентифікація

1. Вимагайте 2FA для всіх членів організації
2. Регулярно перевіряйте статус 2FA для всіх користувачів

### Автоматизовані перевірки безпеки

1. Налаштуйте Dependabot для автоматичного виявлення вразливостей у залежностях
2. Використовуйте GitHub Advanced Security або GitLab Security Dashboard для сканування коду
3. Інтегруйте статичний аналіз коду (SAST) у CI/CD pipeline

## Відповідність ISO 27001

Ці налаштування відповідають наступним вимогам ISO 27001:

- **A.9.2** - Управління доступом користувачів
- **A.9.4** - Контроль доступу до систем та додатків
- **A.12.4** - Протоколювання та моніторинг
- **A.14.2** - Безпека в процесах розробки та підтримки
- **A.18.1** - Відповідність законодавчим та договірним вимогам

## Процес внесення рекомендацій

1. Користувачі з роллю **Read** або **Triage** (GitHub) / **Guest** або **Reporter** (GitLab) можуть створювати Issues з рекомендаціями
2. Для демонстрації змін, користувачі можуть створювати Pull/Merge Requests, але не можуть їх зливати
3. Власники коду (Code Owners) переглядають рекомендації та приймають рішення щодо їх впровадження
4. Тільки авторизовані користувачі з відповідними правами можуть зливати схвалені зміни

## Регулярний аудит налаштувань

1. Проводьте регулярний аудит налаштувань захисту гілок (щонайменше раз на квартал)
2. Перевіряйте журнали доступу та спроб внесення змін
3. Оновлюйте список Code Owners при зміні складу команди
4. Документуйте всі зміни в налаштуваннях безпеки

## Навчання користувачів

1. Проводьте регулярні тренінги з безпеки для всіх користувачів
2. Ознайомлюйте нових користувачів з процесом внесення рекомендацій
3. Документуйте та поширюйте найкращі практики безпеки
